<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>T√≠nh nhanh l·ªó l√£i s√†n TMƒêT by L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --green-bg: #e6f4ea;
      --green-text: #137333;
      --yellow-bg: #fff8e1;
      --yellow-text: #b05a00;
      --red-bg: #fce8e6;
      --red-text: #b3261e;
      --card-radius: 10px;
      --primary: #0b57d0;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 21px;
      margin-top: 0;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }

    /* INPUTS */
    .inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      justify-content: center;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 180px;
      flex: 1;
      max-width: 260px;
    }
    .input-group label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .input-group input {
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      text-align: right;
      background: #fafafa;
    }
    .input-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
      background: #ffffff;
    }

    /* LEGEND */
    .legend {
      margin-top: 4px;
      font-size: 11px;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 4px;
    }
    .color-box {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      margin-right: 4px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* FEES PANEL */
    .fees-panel {
      margin-top: 14px;
      padding: 10px 10px 12px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px dashed #c5d0ff;
    }
    .fees-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #3b4a9a;
    }
    .fees-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .fees-group {
      flex: 1 1 140px;
      min-width: 140px;
    }
    .fees-group label {
      font-size: 11px;
      margin-bottom: 2px;
      display: block;
      color: #555;
    }
    .fees-group input {
      width: 100%;
      padding: 5px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: right;
      outline: none;
      background: #fff;
    }
    .fees-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(11,87,208,0.2);
    }
    .fees-note {
      margin-top: 6px;
      font-size: 10px;
      color: #777;
    }

    /* SUMMARY CARDS */
    .summary-section-title {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .cards-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .card {
      border-radius: var(--card-radius);
      padding: 8px 10px;
      border: 1px solid #eee;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 68px;
    }
    .card-title {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .card-profit {
      font-size: 13px;
      font-weight: 600;
    }
    .card-note {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }

    /* Table */
    .table-wrapper {
      margin-top: 18px;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .table-header span {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .table-hint {
      font-size: 11px;
      color: #777;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 4px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }
    th.sticky {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .pl-cell {
      font-weight: 500;
    }
    .pl-pos {
      background: var(--green-bg);
      color: var(--green-text);
    }
    .pl-low {
      background: var(--yellow-bg);
      color: var(--yellow-text);
    }
    .pl-neg {
      background: var(--red-bg);
      color: var(--red-text);
    }

    .note {
      margin-top: 8px;
      font-size: 11px;
      color: #777;
    }

    /* CTA */
    .cta {
      margin-top: 18px;
      text-align: center;
    }
    .cta-text {
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
    }
    .cta-button {
      display: inline-block;
      padding: 9px 16px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 2px 6px rgba(11,87,208,0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }
    .cta-button:hover {
      background: #0a4ab5;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(11,87,208,0.35);
    }
    .cta-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      .container { padding: 12px 12px 18px; }
      h1 { font-size: 19px; }
      .inputs { flex-direction: column; align-items: stretch; }
      .input-group { max-width: 100%; }
      .cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      table { font-size: 11px; }
      th, td { padding: 4px 2px; }
      .table-hint { font-size: 10px; }
    }
    @media (max-width: 480px) {
      .cards-grid { grid-template-columns: 1fr; }
      .fees-group { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>T√≠nh nhanh l·ªó l√£i s√†n TMƒêT by L·ªó V≈©</h1>
  <div class="subtitle">
    Ph√≠ s√†n <span id="labelPlatformPercent">20</span>% ‚Ä¢
    Thu·∫ø <span id="labelTaxPercent">1,5</span>% ‚Ä¢
    V·∫≠n h√†nh <span id="labelOperatePercent">10</span>% ‚Ä¢
    Qu·∫£ng c√°o <span id="labelAdsPercent">10</span>% ‚Ä¢
    H·∫° t·∫ßng <span id="labelInfraAmount">5.000</span>ƒë/ƒë∆°n ‚Ä¢
    <span id="labelAffSummary">HHLK: 3% ‚Äì 5% ‚Äì 8% ‚Äì 10%</span>
  </div>

  <!-- INPUTS -->
  <div class="inputs">
    <div class="input-group">
      <label for="costPrice">Gi√° v·ªën (A)</label>
      <input id="costPrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° v·ªën" value="100000">
    </div>
    <div class="input-group">
      <label for="salePrice">Gi√° b√°n (B)</label>
      <input id="salePrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° b√°n" value="200000">
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend">
    <span><span class="color-box" style="background:#e6f4ea;"></span>üü¢ L√£i (‚â• 3% doanh thu)</span>
    <span><span class="color-box" style="background:#fff8e1;"></span>üü° H√≤a v·ªën / l√£i &lt; 3%</span>
    <span><span class="color-box" style="background:#fce8e6;"></span>üî¥ L·ªó</span>
  </div>

  <!-- FEES CUSTOMIZATION -->
  <div class="fees-panel">
    <div class="fees-title">T√πy ch·ªânh ph√≠ (n√¢ng cao ‚Äì kh√¥ng b·∫Øt bu·ªôc)</div>
    <div class="fees-grid">
      <div class="fees-group">
        <label for="platformFeeInput">Ph√≠ s√†n (%)</label>
        <input id="platformFeeInput" type="number" step="0.1" min="0" max="50">
      </div>
      <div class="fees-group">
        <label for="taxRateInput">Thu·∫ø (%)</label>
        <input id="taxRateInput" type="number" step="0.1" min="0" max="20">
      </div>
      <div class="fees-group">
        <label for="operationRateInput">V·∫≠n h√†nh (%)</label>
        <input id="operationRateInput" type="number" step="0.1" min="0" max="50">
      </div>
      <div class="fees-group">
        <label for="adsRateInput">Qu·∫£ng c√°o (%)</label>
        <input id="adsRateInput" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="fees-group">
        <label for="infraFeeInput">H·∫° t·∫ßng (ƒë/ƒë∆°n)</label>
        <input id="infraFeeInput" type="number" step="100" min="0">
      </div>
      <div class="fees-group">
        <label for="aff3Input">HHLK m·ª©c 1 (%)</label>
        <input id="aff3Input" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="fees-group">
        <label for="aff5Input">HHLK m·ª©c 2 (%)</label>
        <input id="aff5Input" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="fees-group">
        <label for="aff8Input">HHLK m·ª©c 3 (%)</label>
        <input id="aff8Input" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="fees-group">
        <label for="aff10Input">HHLK m·ª©c 4 (%)</label>
        <input id="aff10Input" type="number" step="0.1" min="0" max="100">
      </div>
    </div>
    <div class="fees-note">
      C√°c gi√° tr·ªã n√†y ch·ªâ d√πng tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n v√† s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i (local storage) ƒë·ªÉ l·∫ßn sau m·ªü l·∫°i v·∫´n gi·ªØ c·∫•u h√¨nh ph√≠.
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-section-title">K·∫øt qu·∫£ nhanh theo t·ª´ng k·ªãch b·∫£n</div>
  <div class="cards-grid">
    <div class="card">
      <div class="card-title">X·∫¢ H√ÄNG (ch·ªâ ph√≠ s√†n + thu·∫ø)</div>
      <div id="cardProfitClearance" class="card-profit pl-cell"></div>
      <div class="card-note">B·ªè chi ph√≠ v·∫≠n h√†nh, qu·∫£ng c√°o, h·∫° t·∫ßng, HHLK.</div>
    </div>
    <div class="card">
      <div class="card-title">KH√îNG ADS, KH√îNG HHLK</div>
      <div id="cardProfitNoAdsNoAff" class="card-profit pl-cell"></div>
      <div class="card-note">Ph√≠ s√†n, thu·∫ø, v·∫≠n h√†nh, h·∫° t·∫ßng.</div>
    </div>
    <div class="card">
      <div class="card-title">FULL ADS, KH√îNG HHLK</div>
      <div id="cardProfitAdsNoAff" class="card-profit pl-cell"></div>
      <div class="card-note">C√≥ qu·∫£ng c√°o, ch∆∞a chia hoa h·ªìng li√™n k·∫øt.</div>
    </div>
    <div class="card">
      <div class="card-title aff3-label">FULL ADS, HHLK 3%</div>
      <div id="cardProfitAdsAff3" class="card-profit pl-cell"></div>
      <div class="card-note">K·ªãch b·∫£n HHLK nh·∫π, th∆∞·ªùng √°p cho KOC nh·ªè.</div>
    </div>
    <div class="card">
      <div class="card-title aff5-label">FULL ADS, HHLK 5%</div>
      <div id="cardProfitAdsAff5" class="card-profit pl-cell"></div>
      <div class="card-note">M·ª©c hoa h·ªìng ph·ªï bi·∫øn cho KOL/KOC.</div>
    </div>
    <div class="card">
      <div class="card-title aff8-label">FULL ADS, HHLK 8%</div>
      <div id="cardProfitAdsAff8" class="card-profit pl-cell"></div>
      <div class="card-note">K·ªãch b·∫£n ∆∞u ƒë√£i m·∫°nh cho ƒë·ªëi t√°c.</div>
    </div>
    <div class="card">
      <div class="card-title aff10-label">FULL ADS, HHLK 10%</div>
      <div id="cardProfitAdsAff10" class="card-profit pl-cell"></div>
      <div class="card-note">M·ª©c hoa h·ªìng r·∫•t cao, c·∫ßn ki·ªÉm so√°t k·ªπ.</div>
    </div>
  </div>

  <!-- DETAIL TABLE -->
  <div class="table-wrapper">
    <div class="table-header">
      <span>Chi ti·∫øt ph√≠ & l√£i</span>
      <span class="table-hint">Vu·ªët ngang ƒë·ªÉ xem ƒë·ªß c·ªôt tr√™n m√†n h√¨nh nh·ªè.</span>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
        <tr>
          <th class="sticky">Gi√° v·ªën<br>(A)</th>
          <th class="sticky">Gi√° b√°n<br>(B)</th>
          <th class="sticky">Ph√≠ s√†n<br>20% (C)</th>
          <th class="sticky">Thu·∫ø<br>1,5% (D)</th>
          <th class="sticky">V·∫≠n h√†nh<br>10% (E)</th>
          <th class="sticky">Qu·∫£ng c√°o<br>10% (F)</th>
          <th class="sticky">H·∫° t·∫ßng<br>5.000ƒë (G)</th>
          <th class="sticky">L√£i<br>X·∫¢ H√ÄNG</th>
          <th class="sticky">L√£i<br>KH√îNG ADS,<br>KH√îNG HHLK</th>
          <th class="sticky">L√£i<br>FULL ADS,<br>KH√îNG HHLK</th>
          <th class="sticky aff3-header">L√£i<br>FULL ADS,<br>HHLK 3%</th>
          <th class="sticky aff5-header">L√£i<br>FULL ADS,<br>HHLK 5%</th>
          <th class="sticky aff8-header">L√£i<br>FULL ADS,<br>HHLK 8%</th>
          <th class="sticky aff10-header">L√£i<br>FULL ADS,<br>HHLK 10%</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td id="cellA"></td>
          <td id="cellB"></td>
          <td id="cellC"></td>
          <td id="cellD"></td>
          <td id="cellE"></td>
          <td id="cellF"></td>
          <td id="cellG"></td>
          <td id="cellProfitClearance" class="pl-cell"></td>
          <td id="cellProfitNoAdsNoAff" class="pl-cell"></td>
          <td id="cellProfitAdsNoAff" class="pl-cell"></td>
          <td id="cellProfitAdsAff3" class="pl-cell"></td>
          <td id="cellProfitAdsAff5" class="pl-cell"></td>
          <td id="cellProfitAdsAff8" class="pl-cell"></td>
          <td id="cellProfitAdsAff10" class="pl-cell"></td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="note">
    ‚Ä¢ Bi√™n l·ª£i nhu·∫≠n (%) t√≠nh tr√™n gi√° b√°n B. V√≠ d·ª•: l√£i 10.000 tr√™n gi√° b√°n 200.000 th√¨ % ‚âà 5%.<br>
    ‚Ä¢ Khi g√µ 100000 ph·∫ßn m·ªÅm s·∫Ω hi·ªÉn th·ªã 100.000 ƒë·ªÉ h·∫°n ch·∫ø nh·∫ßm s·ªë 0.
  </div>

  <!-- CTA to nguoibanlo.vn -->
  <div class="cta">
    <div class="cta-text">Mu·ªën ƒë√†o s√¢u th√™m v·ªÅ chi·∫øn l∆∞·ª£c & v·∫≠n h√†nh tr√™n s√†n?</div>
    <a class="cta-button" href="https://nguoibanlo.vn" target="_blank" rel="noopener noreferrer">
      ƒê·ªçc th√™m c√°c b√†i vi·∫øt v·ªÅ TMƒêT c·ªßa L·ªó V≈©
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const STORAGE_KEY = 'loilai_fee_config_v1';

    const DEFAULT_CONFIG = {
      platformFeeRate: 0.20,  // 20% ph√≠ s√†n
      taxRate: 0.015,         // 1.5%
      operationRate: 0.10,    // 10%
      adsRate: 0.10,          // 10%
      infraFee: 5000,
      aff3Rate: 0.03,
      aff5Rate: 0.05,
      aff8Rate: 0.08,
      aff10Rate: 0.10
    };

    let CONFIG = { ...DEFAULT_CONFIG };

    function loadConfigFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        CONFIG = { ...CONFIG, ...saved };
      } catch (e) {
        console.warn('Cannot load config from storage', e);
      }
    }

    function saveConfigToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(CONFIG));
      } catch (e) {
        console.warn('Cannot save config to storage', e);
      }
    }

    const costInput = document.getElementById('costPrice');
    const saleInput = document.getElementById('salePrice');

    const cellA = document.getElementById('cellA');
    const cellB = document.getElementById('cellB');
    const cellC = document.getElementById('cellC');
    const cellD = document.getElementById('cellD');
    const cellE = document.getElementById('cellE');
    const cellF = document.getElementById('cellF');
    const cellG = document.getElementById('cellG');

    const cellProfitClearance   = document.getElementById('cellProfitClearance');
    const cellProfitNoAdsNoAff  = document.getElementById('cellProfitNoAdsNoAff');
    const cellProfitAdsNoAff    = document.getElementById('cellProfitAdsNoAff');
    const cellProfitAdsAff3     = document.getElementById('cellProfitAdsAff3');
    const cellProfitAdsAff5     = document.getElementById('cellProfitAdsAff5');
    const cellProfitAdsAff8     = document.getElementById('cellProfitAdsAff8');
    const cellProfitAdsAff10    = document.getElementById('cellProfitAdsAff10');

    const cardProfitClearance   = document.getElementById('cardProfitClearance');
    const cardProfitNoAdsNoAff  = document.getElementById('cardProfitNoAdsNoAff');
    const cardProfitAdsNoAff    = document.getElementById('cardProfitAdsNoAff');
    const cardProfitAdsAff3     = document.getElementById('cardProfitAdsAff3');
    const cardProfitAdsAff5     = document.getElementById('cardProfitAdsAff5');
    const cardProfitAdsAff8     = document.getElementById('cardProfitAdsAff8');
    const cardProfitAdsAff10    = document.getElementById('cardProfitAdsAff10');

    const platformFeeInput   = document.getElementById('platformFeeInput');
    const taxRateInput       = document.getElementById('taxRateInput');
    const operationRateInput = document.getElementById('operationRateInput');
    const adsRateInput       = document.getElementById('adsRateInput');
    const infraFeeInput      = document.getElementById('infraFeeInput');
    const aff3Input          = document.getElementById('aff3Input');
    const aff5Input          = document.getElementById('aff5Input');
    const aff8Input          = document.getElementById('aff8Input');
    const aff10Input         = document.getElementById('aff10Input');

    const labelPlatformPercent = document.getElementById('labelPlatformPercent');
    const labelTaxPercent      = document.getElementById('labelTaxPercent');
    const labelOperatePercent  = document.getElementById('labelOperatePercent');
    const labelAdsPercent      = document.getElementById('labelAdsPercent');
    const labelInfraAmount     = document.getElementById('labelInfraAmount');
    const labelAffSummary      = document.getElementById('labelAffSummary');

    function formatNumber(value) {
      if (!isFinite(value)) return '';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
    }

    function formatPercentDisplay(rate) {
      return (rate * 100).toLocaleString('vi-VN', { maximumFractionDigits: 2 }).replace(/\s/g, '');
    }

    function parseMoney(str) {
      const digits = String(str || '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }

    function normalizeInput(el) {
      if (!el) return 0;
      const num = parseMoney(el.value);
      if (num === 0) {
        el.value = '';
        return 0;
      }
      el.value = num.toLocaleString('vi-VN');
      return num;
    }

    function formatProfitWithMargin(profit, salePrice) {
      if (!isFinite(profit)) return '';
      const base = salePrice || 0;
      let text = formatNumber(profit);
      if (base > 0) {
        const margin = profit / base * 100;
        text += " (" + margin.toFixed(1) + "%)";
      }
      return text;
    }

    function applyProfitStyle(el, profit, salePrice) {
      if (!el) return;
      el.classList.remove('pl-pos','pl-low','pl-neg');
      const base = salePrice || 0;
      let margin = 0;
      if (base > 0) margin = profit / base;

      if (profit < 0) {
        el.classList.add('pl-neg');
      } else if (profit === 0 || margin < 0.03) {
        el.classList.add('pl-low');
      } else {
        el.classList.add('pl-pos');
      }
      el.textContent = formatProfitWithMargin(profit, salePrice);
    }

    function updateScenario(cellEl, cardEl, profit, salePrice) {
      applyProfitStyle(cellEl,  profit, salePrice);
      applyProfitStyle(cardEl,  profit, salePrice);
    }

    function updateLabelsFromConfig() {
      if (labelPlatformPercent) labelPlatformPercent.textContent = formatPercentDisplay(CONFIG.platformFeeRate);
      if (labelTaxPercent)      labelTaxPercent.textContent      = formatPercentDisplay(CONFIG.taxRate);
      if (labelOperatePercent)  labelOperatePercent.textContent  = formatPercentDisplay(CONFIG.operationRate);
      if (labelAdsPercent)      labelAdsPercent.textContent      = formatPercentDisplay(CONFIG.adsRate);
      if (labelInfraAmount)     labelInfraAmount.textContent     = formatNumber(CONFIG.infraFee);

      const aff3 = formatPercentDisplay(CONFIG.aff3Rate);
      const aff5 = formatPercentDisplay(CONFIG.aff5Rate);
      const aff8 = formatPercentDisplay(CONFIG.aff8Rate);
      const aff10= formatPercentDisplay(CONFIG.aff10Rate);

      if (labelAffSummary) {
        labelAffSummary.textContent = "HHLK: " + aff3 + "% ‚Äì " + aff5 + "% ‚Äì " + aff8 + "% ‚Äì " + aff10 + "%";
      }

      document.querySelectorAll('.aff3-label').forEach(el => {
        el.textContent = "FULL ADS, HHLK " + aff3 + "%";
      });
      document.querySelectorAll('.aff5-label').forEach(el => {
        el.textContent = "FULL ADS, HHLK " + aff5 + "%";
      });
      document.querySelectorAll('.aff8-label').forEach(el => {
        el.textContent = "FULL ADS, HHLK " + aff8 + "%";
      });
      document.querySelectorAll('.aff10-label').forEach(el => {
        el.textContent = "FULL ADS, HHLK " + aff10 + "%";
      });

      document.querySelectorAll('.aff3-header').forEach(el => {
        el.innerHTML = "L√£i<br>FULL ADS,<br>HHLK " + aff3 + "%";
      });
      document.querySelectorAll('.aff5-header').forEach(el => {
        el.innerHTML = "L√£i<br>FULL ADS,<br>HHLK " + aff5 + "%";
      });
      document.querySelectorAll('.aff8-header').forEach(el => {
        el.innerHTML = "L√£i<br>FULL ADS,<br>HHLK " + aff8 + "%";
      });
      document.querySelectorAll('.aff10-header').forEach(el => {
        el.innerHTML = "L√£i<br>FULL ADS,<br>HHLK " + aff10 + "%";
      });
    }

    function fillFeeInputsFromConfig() {
      if (platformFeeInput)   platformFeeInput.value   = (CONFIG.platformFeeRate * 100).toString();
      if (taxRateInput)       taxRateInput.value       = (CONFIG.taxRate * 100).toString();
      if (operationRateInput) operationRateInput.value = (CONFIG.operationRate * 100).toString();
      if (adsRateInput)       adsRateInput.value       = (CONFIG.adsRate * 100).toString();
      if (infraFeeInput)      infraFeeInput.value      = CONFIG.infraFee.toString();
      if (aff3Input)          aff3Input.value          = (CONFIG.aff3Rate * 100).toString();
      if (aff5Input)          aff5Input.value          = (CONFIG.aff5Rate * 100).toString();
      if (aff8Input)          aff8Input.value          = (CONFIG.aff8Rate * 100).toString();
      if (aff10Input)         aff10Input.value         = (CONFIG.aff10Rate * 100).toString();
    }

    function parsePercentInput(el, fallback) {
      if (!el) return fallback;
      const v = String(el.value || "").replace(',', '.');
      const num = parseFloat(v);
      if (!isFinite(num) || num < 0) return fallback;
      return num / 100;
    }

    function parseNumberInput(el, fallback) {
      if (!el) return fallback;
      const num = parseFloat(el.value);
      if (!isFinite(num) || num < 0) return fallback;
      return Math.round(num);
    }

    function handleFeesChange() {
      CONFIG.platformFeeRate = parsePercentInput(platformFeeInput, CONFIG.platformFeeRate);
      CONFIG.taxRate         = parsePercentInput(taxRateInput, CONFIG.taxRate);
      CONFIG.operationRate   = parsePercentInput(operationRateInput, CONFIG.operationRate);
      CONFIG.adsRate         = parsePercentInput(adsRateInput, CONFIG.adsRate);
      CONFIG.infraFee        = parseNumberInput(infraFeeInput, CONFIG.infraFee);
      CONFIG.aff3Rate        = parsePercentInput(aff3Input, CONFIG.aff3Rate);
      CONFIG.aff5Rate        = parsePercentInput(aff5Input, CONFIG.aff5Rate);
      CONFIG.aff8Rate        = parsePercentInput(aff8Input, CONFIG.aff8Rate);
      CONFIG.aff10Rate       = parsePercentInput(aff10Input, CONFIG.aff10Rate);

      fillFeeInputsFromConfig(); // chu·∫©n ho√° l·∫°i s·ªë tr√™n √¥
      saveConfigToStorage();
      updateLabelsFromConfig();
      recalc();
    }

    function recalc() {
      const A = normalizeInput(costInput);
      const B = normalizeInput(saleInput);

      const feePlatform = B * CONFIG.platformFeeRate;
      const feeTax      = B * CONFIG.taxRate;
      const feeOperate  = B * CONFIG.operationRate;
      const feeAds      = B * CONFIG.adsRate;
      const feeInfra    = CONFIG.infraFee;

      // X·∫£ h√†ng: ch·ªâ tr·ª´ s√†n + thu·∫ø
      const profitClearance   = B - A - feePlatform - feeTax;

      // C√°c k·ªãch b·∫£n kh√°c
      const profitNoAdsNoAff  = B - A - feePlatform - feeTax - feeOperate - feeInfra;
      const profitAdsNoAff    = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra;

      const feeAff3  = B * CONFIG.aff3Rate;
      const feeAff5  = B * CONFIG.aff5Rate;
      const feeAff8  = B * CONFIG.aff8Rate;
      const feeAff10 = B * CONFIG.aff10Rate;

      const profitAdsAff3  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff3;
      const profitAdsAff5  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff5;
      const profitAdsAff8  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff8;
      const profitAdsAff10 = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff10;

      if (cellA) cellA.textContent = formatNumber(A);
      if (cellB) cellB.textContent = formatNumber(B);
      if (cellC) cellC.textContent = formatNumber(feePlatform);
      if (cellD) cellD.textContent = formatNumber(feeTax);
      if (cellE) cellE.textContent = formatNumber(feeOperate);
      if (cellF) cellF.textContent = formatNumber(feeAds);
      if (cellG) cellG.textContent = formatNumber(feeInfra);

      updateScenario(cellProfitClearance,  cardProfitClearance,  profitClearance,  B);
      updateScenario(cellProfitNoAdsNoAff, cardProfitNoAdsNoAff, profitNoAdsNoAff, B);
      updateScenario(cellProfitAdsNoAff,   cardProfitAdsNoAff,   profitAdsNoAff,   B);
      updateScenario(cellProfitAdsAff3,    cardProfitAdsAff3,    profitAdsAff3,    B);
      updateScenario(cellProfitAdsAff5,    cardProfitAdsAff5,    profitAdsAff5,    B);
      updateScenario(cellProfitAdsAff8,    cardProfitAdsAff8,    profitAdsAff8,    B);
      updateScenario(cellProfitAdsAff10,   cardProfitAdsAff10,   profitAdsAff10,   B);
    }

    // ---- Kh·ªüi t·∫°o ----
    loadConfigFromStorage();
    fillFeeInputsFromConfig();
    updateLabelsFromConfig();

    if (platformFeeInput)   platformFeeInput.addEventListener('change', handleFeesChange);
    if (taxRateInput)       taxRateInput.addEventListener('change', handleFeesChange);
    if (operationRateInput) operationRateInput.addEventListener('change', handleFeesChange);
    if (adsRateInput)       adsRateInput.addEventListener('change', handleFeesChange);
    if (infraFeeInput)      infraFeeInput.addEventListener('change', handleFeesChange);
    if (aff3Input)          aff3Input.addEventListener('change', handleFeesChange);
    if (aff5Input)          aff5Input.addEventListener('change', handleFeesChange);
    if (aff8Input)          aff8Input.addEventListener('change', handleFeesChange);
    if (aff10Input)         aff10Input.addEventListener('change', handleFeesChange);

    if (costInput) costInput.addEventListener('input', recalc);
    if (saleInput) saleInput.addEventListener('input', recalc);

    recalc();
  });
</script>
</body>
</html>