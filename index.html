<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>T√≠nh nhanh l·ªó l√£i s√†n TMƒêT by L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --green-bg: #e6f4ea;
      --green-text: #137333;
      --yellow-bg: #fff8e1;
      --yellow-text: #b05a00;
      --red-bg: #fce8e6;
      --red-text: #b3261e;
      --card-radius: 10px;
      --primary: #0b57d0;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .hidden { display: none; }

    /* Sticky header (ti√™u ƒë·ªÅ + √¥ nh·∫≠p + legend + n√∫t setting) */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: #ffffff;
      padding-top: 4px;
      padding-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

    h1 {
      font-size: 21px;
      margin-top: 0;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 0.01em;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }

    /* INPUTS */
    .inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 8px;
      justify-content: center;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 180px;
      flex: 1;
      max-width: 260px;
    }
    .input-group label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .input-group input {
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      text-align: right;
      background: #fafafa;
    }
    .input-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.15);
      background: #ffffff;
    }

    /* SETTINGS (t√πy ch·ªânh ph√≠) */
    .settings {
      margin-bottom: 6px;
      display: flex;
      justify-content: center;
    }
    .settings-toggle {
      border: none;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: #444;
    }
    .settings-toggle:hover {
      background: #e5e7eb;
    }
    .settings-panel {
      margin-top: 10px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #e5e5e5;
      padding: 10px 12px;
      font-size: 12px;
    }
    .settings-panel.hidden {
      display: none;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 12px;
      margin-bottom: 10px;
    }
    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .settings-field label {
      font-size: 11px;
      color: #555;
    }
    .settings-field input {
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      text-align: right;
      background: #fff;
    }
    .settings-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,87,208,0.12);
    }
    .settings-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }
    .btn-primary:hover {
      background: #0a4ab5;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #ddd;
      color: #555;
    }
    .btn-ghost:hover {
      background: #f3f4f6;
    }

    /* LEGEND */
    .legend {
      margin-top: 2px;
      font-size: 11px;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 4px;
    }
    .color-box {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      margin-right: 4px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* SUMMARY CARDS */
    .summary-section-title {
      margin-top: 16px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .cards-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .card {
      border-radius: var(--card-radius);
      padding: 8px 10px;
      border: 1px solid #eee;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 68px;
    }
    .card-title {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .card-profit {
      font-size: 13px;
      font-weight: 600;
    }
    .card-note {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }

    /* Table */
    .table-wrapper {
      margin-top: 18px;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .table-header span {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .table-hint {
      font-size: 11px;
      color: #777;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 4px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }
    th.sticky {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .pl-cell {
      font-weight: 500;
    }
    .pl-pos {
      background: var(--green-bg);
      color: var(--green-text);
    }
    .pl-low {
      background: var(--yellow-bg);
      color: var(--yellow-text);
    }
    .pl-neg {
      background: var(--red-bg);
      color: var(--red-text);
    }

    .note {
      margin-top: 8px;
      font-size: 11px;
      color: #777;
    }

    /* CTA */
    .cta {
      margin-top: 18px;
      text-align: center;
    }
    .cta-text {
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
    }
    .cta-button {
      display: inline-block;
      padding: 9px 16px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 2px 6px rgba(11,87,208,0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }
    .cta-button:hover {
      background: #0a4ab5;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(11,87,208,0.35);
    }
    .cta-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(11,87,208,0.25);
    }

    /* MOBILE */
    @media (max-width: 900px) {
      .settings-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 768px) {
      .container { padding: 12px 12px 18px; }
      h1 { font-size: 19px; }
      .cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      table { font-size: 11px; }
      th, td { padding: 4px 2px; }
      .table-hint { font-size: 10px; }
    }
    @media (max-width: 480px) {
      .settings-grid { grid-template-columns: 1fr; }
      .cards-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- STICKY HEADER -->
  <div class="sticky-header">
    <h1>T√≠nh nhanh l·ªó l√£i s√†n TMƒêT by L·ªó V≈©</h1>
    <div class="subtitle">
      Ph√≠ s√†n <span id="labelPlatformRate">20%</span> ‚Ä¢ Thu·∫ø <span id="labelTaxRate">1,5%</span> ‚Ä¢
      V·∫≠n h√†nh <span id="labelOperationRate">10%</span> ‚Ä¢ Qu·∫£ng c√°o <span id="labelAdsRate">10%</span> ‚Ä¢
      H·∫° t·∫ßng <span id="labelInfraFee">5.000</span>ƒë/ƒë∆°n ‚Ä¢
      HHLK: <span id="labelAffRates">3% ‚Äì 5% ‚Äì 8% ‚Äì 10%</span>
    </div>

    <!-- INPUTS -->
    <div class="inputs">
      <div class="input-group">
        <label for="costPrice">Gi√° v·ªën (A)</label>
        <input id="costPrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° v·ªën" value="100000">
      </div>
      <div class="input-group">
        <label for="salePrice">Gi√° b√°n (B)</label>
        <input id="salePrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° b√°n" value="200000">
      </div>
    </div>

    <!-- SETTINGS TOGGLE -->
    <div class="settings">
      <button type="button" class="settings-toggle" id="settingsToggle">
        ‚öôÔ∏è T√πy ch·ªânh ph√≠ (b·∫•m ƒë·ªÉ m·ªü / ƒë√≥ng)
      </button>
    </div>

    <!-- LEGEND -->
    <div class="legend">
      <span><span class="color-box" style="background:#e6f4ea;"></span>üü¢ L√£i (‚â• 3% doanh thu)</span>
      <span><span class="color-box" style="background:#fff8e1;"></span>üü° H√≤a v·ªën / l√£i &lt; 3%</span>
      <span><span class="color-box" style="background:#fce8e6;"></span>üî¥ L·ªó</span>
    </div>
  </div>

  <!-- SETTINGS PANEL (collapsible) -->
  <div class="settings-panel hidden" id="settingsPanel">
    <div style="margin-bottom:6px;font-size:11px;color:#666;">
      C√°c gi√° tr·ªã m·∫∑c ƒë·ªãnh ph√π h·ª£p hi·ªán t·∫°i, nh∆∞ng b·∫°n c√≥ th·ªÉ ch·ªânh l·∫°i n·∫øu s√†n thay ƒë·ªïi bi·ªÉu ph√≠.
      C√†i ƒë·∫∑t s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n thi·∫øt b·ªã &amp; tr√¨nh duy·ªát n√†y.
    </div>
    <div class="settings-grid">
      <div class="settings-field">
        <label for="cfgPlatformRate">Ph√≠ s√†n (% doanh thu)</label>
        <input id="cfgPlatformRate" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgTaxRate">Thu·∫ø (% doanh thu)</label>
        <input id="cfgTaxRate" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgOperationRate">V·∫≠n h√†nh (% doanh thu)</label>
        <input id="cfgOperationRate" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgAdsRate">Qu·∫£ng c√°o (% doanh thu)</label>
        <input id="cfgAdsRate" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgInfraFee">H·∫° t·∫ßng (ƒë/ƒë∆°n)</label>
        <input id="cfgInfraFee" type="number" step="100" min="0">
      </div>
      <div class="settings-field">
        <label for="cfgAff1">HHLK m·ª©c 1 (%)</label>
        <input id="cfgAff1" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgAff2">HHLK m·ª©c 2 (%)</label>
        <input id="cfgAff2" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgAff3">HHLK m·ª©c 3 (%)</label>
        <input id="cfgAff3" type="number" step="0.1" min="0" max="100">
      </div>
      <div class="settings-field">
        <label for="cfgAff4">HHLK m·ª©c 4 (%)</label>
        <input id="cfgAff4" type="number" step="0.1" min="0" max="100">
      </div>
    </div>
    <div class="settings-actions">
      <button type="button" class="btn btn-ghost" id="btnResetSettings">ƒê∆∞a v·ªÅ m·∫∑c ƒë·ªãnh</button>
      <button type="button" class="btn btn-primary" id="btnSaveSettings">L∆∞u &amp; √°p d·ª•ng</button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-section-title">K·∫øt qu·∫£ nhanh theo t·ª´ng k·ªãch b·∫£n</div>
  <div class="cards-grid">
    <!-- KH√îNG ADS, KH√îNG HHLK -->
    <div class="card">
      <div class="card-title">KH√îNG ADS, KH√îNG HHLK</div>
      <div id="cardProfitNoAdsNoAff" class="card-profit pl-cell"></div>
      <div class="card-note">Ph√≠ s√†n, thu·∫ø, v·∫≠n h√†nh, h·∫° t·∫ßng.</div>
    </div>

    <!-- FULL ADS, KH√îNG HHLK -->
    <div class="card">
      <div class="card-title">FULL ADS, KH√îNG HHLK</div>
      <div id="cardProfitAdsNoAff" class="card-profit pl-cell"></div>
      <div class="card-note">C√≥ qu·∫£ng c√°o, ch∆∞a chia hoa h·ªìng li√™n k·∫øt.</div>
    </div>

    <!-- FULL ADS + HHLK -->
    <div class="card">
      <div class="card-title">FULL ADS, HHLK <span id="labelAff1">3%</span></div>
      <div id="cardProfitAdsAff1" class="card-profit pl-cell"></div>
      <div class="card-note">K·ªãch b·∫£n HHLK nh·∫π, th∆∞·ªùng √°p cho KOC nh·ªè.</div>
    </div>
    <div class="card">
      <div class="card-title">FULL ADS, HHLK <span id="labelAff2">5%</span></div>
      <div id="cardProfitAdsAff2" class="card-profit pl-cell"></div>
      <div class="card-note">M·ª©c hoa h·ªìng ph·ªï bi·∫øn cho KOL/KOC.</div>
    </div>
    <div class="card">
      <div class="card-title">FULL ADS, HHLK <span id="labelAff3">8%</span></div>
      <div id="cardProfitAdsAff3" class="card-profit pl-cell"></div>
      <div class="card-note">K·ªãch b·∫£n ∆∞u ƒë√£i m·∫°nh cho ƒë·ªëi t√°c.</div>
    </div>
    <div class="card">
      <div class="card-title">FULL ADS, HHLK <span id="labelAff4">10%</span></div>
      <div id="cardProfitAdsAff4" class="card-profit pl-cell"></div>
      <div class="card-note">M·ª©c hoa h·ªìng r·∫•t cao, c·∫ßn ki·ªÉm so√°t k·ªπ.</div>
    </div>

    <!-- X·∫¢ H√ÄNG: cho xu·ªëng cu·ªëi -->
    <div class="card">
      <div class="card-title">X·∫¢ H√ÄNG (ch·ªâ ph√≠ s√†n + thu·∫ø)</div>
      <div id="cardProfitClearance" class="card-profit pl-cell"></div>
      <div class="card-note">B·ªè chi ph√≠ v·∫≠n h√†nh, qu·∫£ng c√°o, h·∫° t·∫ßng, HHLK.</div>
    </div>
  </div>

  <!-- DETAIL TABLE -->
  <div class="table-wrapper">
    <div class="table-header">
      <span>Chi ti·∫øt ph√≠ &amp; l√£i</span>
      <span class="table-hint">Vu·ªët ngang ƒë·ªÉ xem ƒë·ªß c·ªôt tr√™n m√†n h√¨nh nh·ªè.</span>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
        <tr>
          <th class="sticky">Gi√° v·ªën<br>(A)</th>
          <th class="sticky">Gi√° b√°n<br>(B)</th>
          <th class="sticky">Ph√≠ s√†n<br><span id="thPlatformRate">20%</span> (C)</th>
          <th class="sticky">Thu·∫ø<br><span id="thTaxRate">1,5%</span> (D)</th>
          <th class="sticky">V·∫≠n h√†nh<br><span id="thOperationRate">10%</span> (E)</th>
          <th class="sticky">Qu·∫£ng c√°o<br><span id="thAdsRate">10%</span> (F)</th>
          <th class="sticky">H·∫° t·∫ßng<br><span id="thInfraFee">5.000</span>ƒë (G)</th>
          <th class="sticky">L√£i<br>KH√îNG ADS,<br>KH√îNG HHLK</th>
          <th class="sticky">L√£i<br>FULL ADS,<br>KH√îNG HHLK</th>
          <th class="sticky">L√£i<br>FULL ADS,<br>HHLK <span id="thAff1">3%</span></th>
          <th class="sticky">L√£i<br>FULL ADS,<br>HHLK <span id="thAff2">5%</span></th>
          <th class="sticky">L√£i<br>FULL ADS,<br>HHLK <span id="thAff3">8%</span></th>
          <th class="sticky">L√£i<br>FULL ADS,<br>HHLK <span id="thAff4">10%</span></th>
          <th class="sticky">L√£i<br>X·∫¢ H√ÄNG</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td id="cellA"></td>
          <td id="cellB"></td>
          <td id="cellC"></td>
          <td id="cellD"></td>
          <td id="cellE"></td>
          <td id="cellF"></td>
          <td id="cellG"></td>
          <td id="cellProfitNoAdsNoAff" class="pl-cell"></td>
          <td id="cellProfitAdsNoAff" class="pl-cell"></td>
          <td id="cellProfitAdsAff1" class="pl-cell"></td>
          <td id="cellProfitAdsAff2" class="pl-cell"></td>
          <td id="cellProfitAdsAff3" class="pl-cell"></td>
          <td id="cellProfitAdsAff4" class="pl-cell"></td>
          <td id="cellProfitClearance" class="pl-cell"></td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="note">
    ‚Ä¢ Bi√™n l·ª£i nhu·∫≠n (%) t√≠nh tr√™n gi√° b√°n B. V√≠ d·ª•: l√£i 10.000 tr√™n gi√° b√°n 200.000 th√¨ % ‚âà 5%.<br>
    ‚Ä¢ Khi g√µ 100000 ph·∫ßn m·ªÅm s·∫Ω hi·ªÉn th·ªã 100.000 ƒë·ªÉ h·∫°n ch·∫ø nh·∫ßm s·ªë 0.
  </div>

  <!-- CTA -->
  <div class="cta">
    <div class="cta-text">Mu·ªën ƒë√†o s√¢u th√™m v·ªÅ chi·∫øn l∆∞·ª£c &amp; v·∫≠n h√†nh tr√™n s√†n?</div>
    <a class="cta-button" href="https://nguoibanlo.vn" target="_blank" rel="noopener noreferrer">
      ƒê·ªçc th√™m c√°c b√†i vi·∫øt v·ªÅ TMƒêT c·ªßa L·ªó V≈©
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const DEFAULT_CONFIG = {
      platformFeeRate: 0.20,
      taxRate: 0.015,
      operationRate: 0.10,
      adsRate: 0.10,
      infraFee: 5000,
      affRates: [0.03, 0.05, 0.08, 0.10]
    };
    const STORAGE_KEY = 'loilaisan_config_v1';
    let CONFIG = { ...DEFAULT_CONFIG };

    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        CONFIG = { ...DEFAULT_CONFIG, ...data };
        if (!Array.isArray(CONFIG.affRates)) {
          CONFIG.affRates = DEFAULT_CONFIG.affRates.slice();
        }
      } catch (e) {
        CONFIG = { ...DEFAULT_CONFIG };
      }
    }
    function saveConfig() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(CONFIG));
      } catch (e) {}
    }

    function formatNumber(value) {
      if (!isFinite(value)) return '';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
    }
    function parseMoney(str) {
      const digits = String(str || '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }
    function normalizeInput(el) {
      if (!el) return 0;
      const num = parseMoney(el.value);
      if (num === 0) {
        el.value = '';
        return 0;
      }
      el.value = num.toLocaleString('vi-VN');
      return num;
    }
    function formatPercent(rate) {
      const value = rate * 100;
      if (Number.isInteger(value)) return value.toString() + '%';
      return value.toLocaleString('vi-VN', { maximumFractionDigits: 1 }) + '%';
    }
    function formatProfitWithMargin(profit, salePrice) {
      if (!isFinite(profit)) return '';
      const base = salePrice || 0;
      let text = formatNumber(profit);
      if (base > 0) {
        const margin = profit / base * 100;
        text += " (" + margin.toFixed(1) + "%)";
      }
      return text;
    }
    function applyProfitStyle(el, profit, salePrice) {
      if (!el) return;
      el.classList.remove('pl-pos','pl-low','pl-neg');
      const base = salePrice || 0;
      let margin = 0;
      if (base > 0) margin = profit / base;

      if (profit < 0) {
        el.classList.add('pl-neg');
      } else if (profit === 0 || margin < 0.03) {
        el.classList.add('pl-low');
      } else {
        el.classList.add('pl-pos');
      }
      el.textContent = formatProfitWithMargin(profit, salePrice);
    }
    function updateScenario(cellEl, cardEl, profit, salePrice) {
      applyProfitStyle(cellEl,  profit, salePrice);
      applyProfitStyle(cardEl,  profit, salePrice);
    }

    // DOM
    const costInput = document.getElementById('costPrice');
    const saleInput = document.getElementById('salePrice');

    const cellA = document.getElementById('cellA');
    const cellB = document.getElementById('cellB');
    const cellC = document.getElementById('cellC');
    const cellD = document.getElementById('cellD');
    const cellE = document.getElementById('cellE');
    const cellF = document.getElementById('cellF');
    const cellG = document.getElementById('cellG');

    const cellProfitClearance   = document.getElementById('cellProfitClearance');
    const cellProfitNoAdsNoAff  = document.getElementById('cellProfitNoAdsNoAff');
    const cellProfitAdsNoAff    = document.getElementById('cellProfitAdsNoAff');
    const cellProfitAdsAff1     = document.getElementById('cellProfitAdsAff1');
    const cellProfitAdsAff2     = document.getElementById('cellProfitAdsAff2');
    const cellProfitAdsAff3     = document.getElementById('cellProfitAdsAff3');
    const cellProfitAdsAff4     = document.getElementById('cellProfitAdsAff4');

    const cardProfitClearance   = document.getElementById('cardProfitClearance');
    const cardProfitNoAdsNoAff  = document.getElementById('cardProfitNoAdsNoAff');
    const cardProfitAdsNoAff    = document.getElementById('cardProfitAdsNoAff');
    const cardProfitAdsAff1     = document.getElementById('cardProfitAdsAff1');
    const cardProfitAdsAff2     = document.getElementById('cardProfitAdsAff2');
    const cardProfitAdsAff3     = document.getElementById('cardProfitAdsAff3');
    const cardProfitAdsAff4     = document.getElementById('cardProfitAdsAff4');

    const labelPlatformRate   = document.getElementById('labelPlatformRate');
    const labelTaxRate        = document.getElementById('labelTaxRate');
    const labelOperationRate  = document.getElementById('labelOperationRate');
    const labelAdsRate        = document.getElementById('labelAdsRate');
    const labelInfraFee       = document.getElementById('labelInfraFee');
    const labelAffRates       = document.getElementById('labelAffRates');

    const thPlatformRate  = document.getElementById('thPlatformRate');
    const thTaxRate       = document.getElementById('thTaxRate');
    const thOperationRate = document.getElementById('thOperationRate');
    const thAdsRate       = document.getElementById('thAdsRate');
    const thInfraFee      = document.getElementById('thInfraFee');

    const labelAff1 = document.getElementById('labelAff1');
    const labelAff2 = document.getElementById('labelAff2');
    const labelAff3 = document.getElementById('labelAff3');
    const labelAff4 = document.getElementById('labelAff4');
    const thAff1    = document.getElementById('thAff1');
    const thAff2    = document.getElementById('thAff2');
    const thAff3    = document.getElementById('thAff3');
    const thAff4    = document.getElementById('thAff4');

    const settingsToggle  = document.getElementById('settingsToggle');
    const settingsPanel   = document.getElementById('settingsPanel');
    const btnSaveSettings = document.getElementById('btnSaveSettings');
    const btnResetSettings= document.getElementById('btnResetSettings');

    const cfgPlatformRate   = document.getElementById('cfgPlatformRate');
    const cfgTaxRate        = document.getElementById('cfgTaxRate');
    const cfgOperationRate  = document.getElementById('cfgOperationRate');
    const cfgAdsRate        = document.getElementById('cfgAdsRate');
    const cfgInfraFee       = document.getElementById('cfgInfraFee');
    const cfgAff1           = document.getElementById('cfgAff1');
    const cfgAff2           = document.getElementById('cfgAff2');
    const cfgAff3           = document.getElementById('cfgAff3');
    const cfgAff4           = document.getElementById('cfgAff4');

    function applyConfigLabels() {
      if (labelPlatformRate) labelPlatformRate.textContent = formatPercent(CONFIG.platformFeeRate);
      if (labelTaxRate)      labelTaxRate.textContent      = formatPercent(CONFIG.taxRate);
      if (labelOperationRate)labelOperationRate.textContent= formatPercent(CONFIG.operationRate);
      if (labelAdsRate)      labelAdsRate.textContent      = formatPercent(CONFIG.adsRate);
      if (labelInfraFee)     labelInfraFee.textContent     = formatNumber(CONFIG.infraFee);

      if (labelAffRates) {
        labelAffRates.textContent = CONFIG.affRates.map(r => formatPercent(r)).join(' ‚Äì ');
      }

      if (thPlatformRate)  thPlatformRate.textContent  = formatPercent(CONFIG.platformFeeRate);
      if (thTaxRate)       thTaxRate.textContent       = formatPercent(CONFIG.taxRate);
      if (thOperationRate) thOperationRate.textContent = formatPercent(CONFIG.operationRate);
      if (thAdsRate)       thAdsRate.textContent       = formatPercent(CONFIG.adsRate);
      if (thInfraFee)      thInfraFee.textContent      = formatNumber(CONFIG.infraFee);

      const [r1, r2, r3, r4] = CONFIG.affRates;
      if (labelAff1) labelAff1.textContent = formatPercent(r1);
      if (labelAff2) labelAff2.textContent = formatPercent(r2);
      if (labelAff3) labelAff3.textContent = formatPercent(r3);
      if (labelAff4) labelAff4.textContent = formatPercent(r4);

      if (thAff1) thAff1.textContent = formatPercent(r1);
      if (thAff2) thAff2.textContent = formatPercent(r2);
      if (thAff3) thAff3.textContent = formatPercent(r3);
      if (thAff4) thAff4.textContent = formatPercent(r4);
    }

    function populateSettingsInputs() {
      cfgPlatformRate.value  = (CONFIG.platformFeeRate * 100).toString();
      cfgTaxRate.value       = (CONFIG.taxRate * 100).toString();
      cfgOperationRate.value = (CONFIG.operationRate * 100).toString();
      cfgAdsRate.value       = (CONFIG.adsRate * 100).toString();
      cfgInfraFee.value      = CONFIG.infraFee.toString();

      cfgAff1.value = (CONFIG.affRates[0] * 100).toString();
      cfgAff2.value = (CONFIG.affRates[1] * 100).toString();
      cfgAff3.value = (CONFIG.affRates[2] * 100).toString();
      cfgAff4.value = (CONFIG.affRates[3] * 100).toString();
    }

    function parsePercentInput(el, fallback) {
      if (!el) return fallback;
      const raw = String(el.value || '').replace(',', '.');
      const num = parseFloat(raw);
      return isFinite(num) ? num : fallback;
    }

    function applySettingsFromInputs() {
      const pPlatform = parsePercentInput(cfgPlatformRate,  CONFIG.platformFeeRate*100);
      const pTax      = parsePercentInput(cfgTaxRate,       CONFIG.taxRate*100);
      const pOper     = parsePercentInput(cfgOperationRate, CONFIG.operationRate*100);
      const pAds      = parsePercentInput(cfgAdsRate,       CONFIG.adsRate*100);
      const infra     = parseMoney(cfgInfraFee.value);

      const pAff1 = parsePercentInput(cfgAff1, CONFIG.affRates[0]*100);
      const pAff2 = parsePercentInput(cfgAff2, CONFIG.affRates[1]*100);
      const pAff3 = parsePercentInput(cfgAff3, CONFIG.affRates[2]*100);
      const pAff4 = parsePercentInput(cfgAff4, CONFIG.affRates[3]*100);

      CONFIG.platformFeeRate = pPlatform / 100;
      CONFIG.taxRate         = pTax / 100;
      CONFIG.operationRate   = pOper / 100;
      CONFIG.adsRate         = pAds / 100;
      CONFIG.infraFee        = infra;

      CONFIG.affRates = [pAff1/100, pAff2/100, pAff3/100, pAff4/100];
    }

    function recalc() {
      const A = normalizeInput(costInput);
      const B = normalizeInput(saleInput);

      const feePlatform = B * CONFIG.platformFeeRate;
      const feeTax      = B * CONFIG.taxRate;
      const feeOperate  = B * CONFIG.operationRate;
      const feeAds      = B * CONFIG.adsRate;
      const feeInfra    = CONFIG.infraFee;

      const profitClearance   = B - A - feePlatform - feeTax;

      const profitNoAdsNoAff  = B - A - feePlatform - feeTax - feeOperate - feeInfra;
      const profitAdsNoAff    = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra;

      const [r1, r2, r3, r4] = CONFIG.affRates;
      const feeAff1 = B * r1;
      const feeAff2 = B * r2;
      const feeAff3 = B * r3;
      const feeAff4 = B * r4;

      const profitAdsAff1  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff1;
      const profitAdsAff2  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff2;
      const profitAdsAff3  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff3;
      const profitAdsAff4  = B - A - feePlatform - feeTax - feeOperate - feeAds - feeInfra - feeAff4;

      if (cellA) cellA.textContent = formatNumber(A);
      if (cellB) cellB.textContent = formatNumber(B);
      if (cellC) cellC.textContent = formatNumber(feePlatform);
      if (cellD) cellD.textContent = formatNumber(feeTax);
      if (cellE) cellE.textContent = formatNumber(feeOperate);
      if (cellF) cellF.textContent = formatNumber(feeAds);
      if (cellG) cellG.textContent = formatNumber(feeInfra);

      updateScenario(cellProfitClearance,  cardProfitClearance,  profitClearance,  B);
      updateScenario(cellProfitNoAdsNoAff, cardProfitNoAdsNoAff, profitNoAdsNoAff, B);
      updateScenario(cellProfitAdsNoAff,   cardProfitAdsNoAff,   profitAdsNoAff,   B);
      updateScenario(cellProfitAdsAff1,    cardProfitAdsAff1,    profitAdsAff1,    B);
      updateScenario(cellProfitAdsAff2,    cardProfitAdsAff2,    profitAdsAff2,    B);
      updateScenario(cellProfitAdsAff3,    cardProfitAdsAff3,    profitAdsAff3,    B);
      updateScenario(cellProfitAdsAff4,    cardProfitAdsAff4,    profitAdsAff4,    B);
    }

    // ==== INIT ====
    loadConfig();
    applyConfigLabels();
    populateSettingsInputs();
    recalc();

    if (costInput) costInput.addEventListener('input', recalc);
    if (saleInput) saleInput.addEventListener('input', recalc);

    if (settingsToggle && settingsPanel) {
      settingsToggle.addEventListener('click', function () {
        settingsPanel.classList.toggle('hidden');
      });
    }

    if (btnSaveSettings) {
      btnSaveSettings.addEventListener('click', function () {
        applySettingsFromInputs();
        saveConfig();
        applyConfigLabels();
        recalc();
      });
    }

    if (btnResetSettings) {
      btnResetSettings.addEventListener('click', function () {
        CONFIG = { ...DEFAULT_CONFIG };
        saveConfig();
        applyConfigLabels();
        populateSettingsInputs();
        recalc();
      });
    }
  });
</script>
</body>
</html>