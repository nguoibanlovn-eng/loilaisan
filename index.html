<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>M√°y t√≠nh l·ªó l√£i s√†n TMƒêT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 8px;
      padding: 16px 20px 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 8px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }
    .inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      justify-content: center;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }
    .input-group label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .input-group input {
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      outline: none;
      text-align: right; /* canh ph·∫£i cho d·ªÖ nh√¨n ti·ªÅn */
    }
    .input-group input:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.15);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 4px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: #fafafa;
      font-weight: 600;
      text-align: center;
    }
    th.sticky {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .legend {
      margin-top: 10px;
      font-size: 11px;
      color: #555;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
    }
    .color-box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin-right: 4px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .note {
      margin-top: 8px;
      font-size: 11px;
      color: #777;
    }

    /* M√†u c·∫£nh b√°o cho √¥ l√£i/l·ªó */
    .pl-cell {
      font-weight: 500;
    }
    .pl-pos {           /* L√£i t·ªët (>=3%) */
      background: #e6f4ea;
      color: #137333;
    }
    .pl-low {           /* H√≤a v·ªën ho·∫∑c l√£i <3% */
      background: #fff8e1;
      color: #b05a00;
    }
    .pl-neg {           /* L·ªó */
      background: #fce8e6;
      color: #b3261e;
    }

    @media (max-width: 768px) {
      table {
        font-size: 11px;
      }
      th, td {
        padding: 4px 2px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>M√°y t√≠nh l·ªó l√£i tr√™n s√†n TMƒêT</h1>
  <div class="subtitle">
    Ph√≠ s√†n 19% ‚Ä¢ Thu·∫ø 1,5% ‚Ä¢ V·∫≠n h√†nh 10% ‚Ä¢ Qu·∫£ng c√°o 10% ‚Ä¢ H·∫° t·∫ßng 5.000ƒë/ƒë∆°n ‚Ä¢ HHLK: 3% ‚Äì 5% ‚Äì 8% ‚Äì 10%
  </div>

  <div class="inputs">
    <div class="input-group">
      <label for="costPrice">Gi√° v·ªën (A)</label>
      <!-- ƒë·ªïi type=number -> text ƒë·ªÉ t·ª± format d·∫•u ch·∫•m -->
      <input id="costPrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° v·ªën" value="100000">
    </div>
    <div class="input-group">
      <label for="salePrice">Gi√° b√°n (B)</label>
      <input id="salePrice" type="text" inputmode="numeric" placeholder="Nh·∫≠p gi√° b√°n" value="200000">
    </div>
  </div>

  <div class="legend">
    <span><span class="color-box" style="background:#e6f4ea;"></span>üü¢ L√£i &nbsp;(‚â• 3% doanh thu)</span>
    <span><span class="color-box" style="background:#fff8e1;"></span>üü° H√≤a v·ªën / l√£i &lt; 3%</span>
    <span><span class="color-box" style="background:#fce8e6;"></span>üî¥ L·ªó</span>
  </div>

  <div style="overflow-x:auto; margin-top: 10px;">
    <table>
      <thead>
      <tr>
        <th class="sticky">Gi√° v·ªën<br>(A)</th>
        <th class="sticky">Gi√° b√°n<br>(B)</th>
        <th class="sticky">Ph√≠ s√†n<br>19% (C)</th>
        <th class="sticky">Thu·∫ø<br>1,5% (D)</th>
        <th class="sticky">V·∫≠n h√†nh<br>10% (E)</th>
        <th class="sticky">Qu·∫£ng c√°o<br>10% (F)</th>
        <th class="sticky">H·∫° t·∫ßng<br>5.000ƒë (G)</th>
        <th class="sticky">L√£i<br>KH√îNG ADS,<br>KH√îNG HHLK</th>
        <th class="sticky">L√£i<br>FULL ADS,<br>KH√îNG HHLK</th>
        <th class="sticky">L√£i<br>FULL ADS,<br>HHLK 3%</th>
        <th class="sticky">L√£i<br>FULL ADS,<br>HHLK 5%</th>
        <th class="sticky">L√£i<br>FULL ADS,<br>HHLK 8%</th>
        <th class="sticky">L√£i<br>FULL ADS,<br>HHLK 10%</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td id="cellA"></td>
        <td id="cellB"></td>
        <td id="cellC"></td>
        <td id="cellD"></td>
        <td id="cellE"></td>
        <td id="cellF"></td>
        <td id="cellG"></td>
        <td id="cellProfitNoAdsNoAff" class="pl-cell"></td>
        <td id="cellProfitAdsNoAff" class="pl-cell"></td>
        <td id="cellProfitAdsAff3" class="pl-cell"></td>
        <td id="cellProfitAdsAff5" class="pl-cell"></td>
        <td id="cellProfitAdsAff8" class="pl-cell"></td>
        <td id="cellProfitAdsAff10" class="pl-cell"></td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="note">
    ‚Ä¢ Bi√™n l·ª£i nhu·∫≠n (%) t√≠nh tr√™n gi√° b√°n B. V√≠ d·ª•: l√£i 10.000 tr√™n gi√° b√°n 200.000 th√¨ % = 5%.<br>
    ‚Ä¢ √î nh·∫≠p ti·ªÅn c√≥ th·ªÉ g√µ 100000, ph·∫ßn m·ªÅm s·∫Ω t·ª± hi·ªán 100.000 cho d·ªÖ ƒë·ªçc.
  </div>
</div>

<script>
  // ==========================
  // C·∫§U H√åNH T·ª∂ L·ªÜ PH√ç
  // ==========================
  const CONFIG = {
    platformFeeRate: 0.19,   // Ph√≠ s√†n 19% doanh thu
    taxRate: 0.015,          // Thu·∫ø 1,5% doanh thu
    operationRate: 0.10,     // V·∫≠n h√†nh 10% doanh thu
    adsRate: 0.10,           // Qu·∫£ng c√°o 10% doanh thu
    infraFee: 5000,          // Ph√≠ h·∫° t·∫ßng c·ªë ƒë·ªãnh 5.000ƒë/ƒë∆°n
    aff3Rate: 0.03,          // HHLK 3%
    aff5Rate: 0.05,          // HHLK 5%
    aff8Rate: 0.08,          // HHLK 8%
    aff10Rate: 0.10          // HHLK 10%
  };

  const costInput = document.getElementById('costPrice');
  const saleInput = document.getElementById('salePrice');

  const cellA = document.getElementById('cellA');
  const cellB = document.getElementById('cellB');
  const cellC = document.getElementById('cellC');
  const cellD = document.getElementById('cellD');
  const cellE = document.getElementById('cellE');
  const cellF = document.getElementById('cellF');
  const cellG = document.getElementById('cellG');

  const cellProfitNoAdsNoAff = document.getElementById('cellProfitNoAdsNoAff');
  const cellProfitAdsNoAff   = document.getElementById('cellProfitAdsNoAff');
  const cellProfitAdsAff3    = document.getElementById('cellProfitAdsAff3');
  const cellProfitAdsAff5    = document.getElementById('cellProfitAdsAff5');
  const cellProfitAdsAff8    = document.getElementById('cellProfitAdsAff8');
  const cellProfitAdsAff10   = document.getElementById('cellProfitAdsAff10');

  function formatNumber(value) {
    if (!isFinite(value)) return '';
    return value.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
  }

  // L·∫•y s·ªë nguy√™n t·ª´ chu·ªói ƒë√£ c√≥ d·∫•u ch·∫•m / k√Ω t·ª± kh√°c
  function getNumericFromFormatted(str) {
    const digits = (str || '').replace(/\D/g, '');
    return digits ? parseInt(digits, 10) : 0;
  }

  // Format √¥ input: 100000 -> "100.000"
  function formatInput(el) {
    const num = getNumericFromFormatted(el.value);
    if (num === 0) {
      el.value = '';
      return 0;
    }
    el.value = num.toLocaleString('vi-VN');
    return num;
  }

  // Hi·ªÉn th·ªã: "10.000 (5%)"
  function formatProfitWithMargin(profit, salePrice) {
    if (!isFinite(profit)) return '';
    const base = parseFloat(salePrice) || 0;
    let text = formatNumber(profit);
    if (base > 0) {
      const margin = profit / base * 100;
      text += " (" + margin.toFixed(1) + "%)";
    }
    return text;
  }

  // G√°n m√†u theo l√£i/l·ªó & % l√£i tr√™n doanh thu
  function setProfitCell(cell, profit, salePrice) {
    cell.classList.remove('pl-pos','pl-low','pl-neg');
    const base = parseFloat(salePrice) || 0;
    let margin = 0;
    if (base > 0) {
      margin = profit / base;
    }

    if (profit < 0) {
      cell.classList.ad
